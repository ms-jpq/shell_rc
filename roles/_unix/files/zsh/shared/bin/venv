#!/usr/bin/env bash

set -Eeu
set -o pipefail
shopt -s nullglob globstar


VIRTUAL_ENV="${VIRTUAL_ENV:-""}"

export DEFAULT_VENV_PATH="${DEFAULT_VENV_PATH:-"${2:-"$PWD/.venv"}"}"

PY_EXE="$DEFAULT_VENV_PATH/bin/python3"
ACTIVATE="$DEFAULT_VENV_PATH/bin/activate"


OP="$1"
shift

read -r -d '' PYPROJ <<-'PYTHON' || true
from itertools import chain
from pathlib import Path
from subprocess import check_call
from sys import executable
from typing import Union

from tomllib import load

py_project = Path("pyproject.toml")
requirements = Path("requirements.txt")


def pip(*argv: Union[str, Path]) -> None:
    check_call(
        (executable, "-m", "pip", "install", "--upgrade", "--require-virtualenv", *argv)
    )


if py_project.is_file():
    with py_project.open("rb") as fd:
        if (toml := load(fd)) and (project := toml.get("project")):
            deps = tuple(
                chain(
                    project.get("dependencies", ()),
                    chain.from_iterable(
                        project.get("optional-dependencies", {}).values()
                    ),
                )
            )
            if deps:
                pip("--", *deps)

if requirements.is_file():
    pip("--requirement", requirements)
PYTHON


case "$OP" in
init)
  if [[ -d "$DEFAULT_VENV_PATH" ]]
  then
    >&2 printf '%s\n' "Virtualenv already initialized"
  else
    >&2 python3 -m venv "$DEFAULT_VENV_PATH"
    >&2 "$PY_EXE" <<< "$PYPROJ"
    >&2 printf '%s\n' "Initialized Virtualenv"
    venv on
  fi
  ;;
on)
  if [[ -f "$ACTIVATE" ]]
  then
    venv off
    printf '%s\n' "source '$ACTIVATE'"
    >&2 printf '%s\n' "Activated - $DEFAULT_VENV_PATH"
  else
    venv init
  fi
  ;;
off)
  if [[ -z "$VIRTUAL_ENV" ]]
  then
    true
  else
    printf '%s\n' 'deactivate'
  fi
  >&2 printf '%s\n' "Deactivating - $VIRTUAL_ENV"
  ;;
rm)
  if [[ -d "$DEFAULT_VENV_PATH" ]]
  then
    if [[ "$VIRTUAL_ENV" = "$DEFAULT_VENV_PATH" ]]
    then
      venv off
    fi
    printf '%s\n' "rm -rf '$DEFAULT_VENV_PATH'"
  fi
  >&2 printf '%s\n' "Removed - $DEFAULT_VENV_PATH"
  ;;
*)
  >&2 printf '%s\n' "Invalid argument"
  >&2 printf '%s\n' "venv - [on | off | rm]"
  ;;
esac
