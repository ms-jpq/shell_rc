#!/usr/bin/env bash

set -eu
set -o pipefail


RG_ARGS="${_RG_ARGS:-""}"


if [[ -z "$RG_ARGS" ]]
then
  ARGS=(
    --line-buffered
    --files-with-matches
    -0
    "$@"
    )
   IFS=$'\0' ENV_ARGS="$*"
   rg "${ARGS[@]}" | SHELL="$0" _RG_ARGS="$ENV_ARGS" exec fzf --read0 --preview='{}'
else
  ARGS=(
    --color=always
    --line-number
    --context=3
    --context-separator="$(hr '-' "$FZF_PREVIEW_COLUMNS")"
    )
  readarray -t -d $'\0' ENV_ARGS <<< "$RG_ARGS"
  echo "${ARGS[@]}" "${ENV_ARGS[@]}" -- "$2"
fi
