#!/usr/bin/env python3

from argparse import ArgumentParser, Namespace
from logging import INFO, StreamHandler, getLogger
from os import execl, getlogin
from shlex import join
from shutil import which
from typing import Tuple
from urllib.parse import urlsplit

log = getLogger()
log.setLevel(INFO)
log.addHandler(StreamHandler())


def _parse_args() -> Namespace:
    parser = ArgumentParser()
    parser.add_argument("jump")
    parser.add_argument("dest")
    parser.add_argument("argv", nargs="...")
    return parser.parse_args()


def _jump(jump: str, default_port: int) -> Tuple[str, str, int]:
    uri = urlsplit(f"ssh://{jump}")
    host = uri.hostname
    port = uri.port or default_port
    user = uri.username or getlogin()
    assert host
    return user, host, port


def main() -> None:
    args = _parse_args()
    j_user, j_host, j_port = _jump(args.jump, default_port=443)
    d_user, d_host, d_port = _jump(args.dest, default_port=22)

    ssh, openssl = which("ssh"), which("openssl")
    assert ssh and openssl

    l1 = join((openssl, "s_client", "-quiet", "--", f"[{j_host}]:{j_port}"))
    l2 = join(
        (ssh, "-o", f"ProxyCommand={l1}", "-W", f"localhost:%p", f"{j_user}@{j_host}")
    )
    argv = (
        ssh,
        "-o",
        f"ProxyCommand={l2}",  # WARN: % substitution is ONLY performed here
        "-p",
        f"{d_port}",
        *args.argv,
        "--",
        f"{d_user}@{d_host}",
    )
    execl(ssh, *argv)


main()
