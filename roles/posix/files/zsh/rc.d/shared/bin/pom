#!/usr/bin/env -S -- bash -Eeuo pipefail -O dotglob -O failglob -O globstar

TTL="$1"
NOW="$(date -- '+%s')"
END=$((TTL * 60 + NOW))

FONT="$(SHOW_FONT=1 big)"
CLS="$(clear)"

colour() {
  if command -v -- gay &>/dev/null; then
    gay
  else
    tee
  fi
}

fig() {
  HR="$(hr)"
  FIG="$HR$(figlet -c -w "$COLS" -f "$FONT" -- "$*" | colour)"
  readarray -t -d $'\n' -- L <<<"$FIG"
  LS="${#L[@]}"

  P=$(((LINES - LS - 1) / 2))

  PAD=()
  for ((i = 0; i < P; i++)); do
    PAD+=($'\n')
  done

  printf -- '%s%s\n%s' "$CLS${PAD[*]}" "$FIG" "$HR"
}

while true; do
  NOW="$(date -- '+%s')"
  if ((NOW <= END)); then
    TIME="$(date --date="@$((END - NOW))" -- '+%M:%S')"
    LINES="$(tput -- lines)"
    COLS="$(tput -- cols)"
    fig "$TIME"
    sleep -- 1
  else
    break
  fi
done

fig "00:00"

notify() {
  if command -v -- osascript &>/dev/null; then
    osascript -e 'display notification "ğŸ…ğŸ…ğŸ…" with title "ğŸ¥«"'
  else
    :
  fi
}

while true; do
  notify
  sleep -- 1
done
