#!/usr/bin/env bash

set -Eeu
set -o pipefail
shopt -s globstar nullglob


read -r -d '' -- AWK <<-'EOF' || true
BEGIN { 
  printf --("\x1BPtmux;")
}
{
  gsub("\x1B", "\x1B\x1B")
  printf --($0)
}
END {
  printf --("\x1B\\")
}
EOF


if [[ -v TMUX ]]
then
  if [[ -v SSH_TTY ]]
  then
    awk "$AWK" | awk "$AWK"
  else
    awk "$AWK"
  fi
elif [[ -v SSH_TTY ]]
then
  awk "$AWK"
else
  tee
fi
