#!/usr/bin/env bash

set -Eeu
set -o pipefail
shopt -s nullglob globstar


OPTS='gv:'
LONG_OPTS='global,version:'

PARSED="$(getopt --options="$OPTS" --longoptions="$LONG_OPTS" --name="$0" -- "$@")"
eval set -- "$PARSED"


GLOBAL=0
VERSION=
LANG=
while true
do
  case "$1" in
    -g|--global)
      GLOBAL=1
      shift
      ;;
    -v|--version)
      VERSION="$2"
      shift 2
      ;;
    --)
      shift
      ;;
    *)
      LANG="$*"
      break
      ;;
  esac
done


if [[ -z "$LANG" ]]
then
  printf -- '%s\n' 'Please Enter a Langauge!'
  exit 2
fi


readarray -t -- PLUGINS < <(asdf plugin list)


PLUGIN_INSTALLED=0
for PLUGIN in "${PLUGINS[@]}"
do
  if [[ "$PLUGIN" = "$LANG" ]]
  then
    PLUGIN_INSTALLED=1
    break
  fi
done


if [[ "$PLUGIN_INSTALLED" -eq 0 ]]
then
  asdf plugin add "$LANG"
else
  asdf plugin update "$LANG"
fi


readarray -t -- INSTALLED < <(asdf list "$LANG")


if [[ -z "$VERSION" ]]
then
  VERSION="$(asdf latest "$LANG")"
fi


VERSION_INSTALLED=0
for VER in "${INSTALLED[@]}"
do
  if [[ "$VER" = "$VERSION" ]]
  then
    VERSION_INSTALLED=1
    break
  fi
done


if [[ "$VERSION_INSTALLED" -eq 0 ]]
then
  asdf install "$LANG" "$VERSION"
fi


if [[ "$GLOBAL" -ne 0 ]]
then
  asdf global "$LANG" "$VERSION"
fi


asdf reshim
