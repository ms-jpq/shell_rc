#!/usr/bin/env -S -- bash -Eeuo pipefail -O dotglob -O nullglob -O failglob -O globstar

bin="$(dirname -- "$0")"
PATH="$(paths --silent remove "$bin")"

EXECUTE=(
  "$(basename -- "$0")"
  "$@"
)

IS_VENV=0
if [[ -v VIRTUAL_ENV ]]; then
  IS_VENV=1
fi

IS_INTERACTIVE=0
if [[ -t 0 ]]; then
  IS_INTERACTIVE=1
fi

IS_INSTALL=0
if [[ $# -gt 0 ]] && [[ "${EXECUTE[1]}" == 'install' ]]; then
  IS_INSTALL=1
fi
for ARG in "$@"; do
  if [[ "$ARG" == '-h' ]] || [[ "$ARG" == '--help' ]]; then
    IS_INSTALL=0
  fi
done

ASK=0
if ! ((IS_VENV)) && ((IS_INTERACTIVE)) && ((IS_INSTALL)); then
  ASK=1
fi

hr() {
  local -- rep="$1"
  local -- cols="$2"
  local -- line=''
  for ((i = 1; i <= cols; i++)); do
    line="$line$rep"
  done
  printf -- '%s\n' "$line" >&2
}

if ! ((ASK)); then
  exec -- "${EXECUTE[@]}"
else
  COLS="$(tput -- cols)"
  type >&2 -a python3
  hr '-' "$COLS"
  printf >&2 -- '%s\n' 'Not in virtual environment:'
  hr '-' "$COLS"
  printf >&2 -- '%s\n' "${EXECUTE[*]}"
  hr '-' "$COLS"

  read -r -p 'Continue (y/n)?' -- CONT
  case "$CONT" in
  1 | y | Y)
    exec -- "${EXECUTE[@]}"
    ;;
  *)
    exit 1
    ;;
  esac
fi
