#!/usr/bin/env node

const assert = require("assert");
const { spawnSync } = require("child_process");
const { existsSync, mkdirSync } = require("fs");
const { dirname, join } = require("path");

process.env["PATH"] = process.env["PATH"]
  .split(":")
  .filter((p) => p !== __dirname)
  .join(":");

const global_home = dirname(dirname(process.env["NPM_GLOBAL_BIN"]));
const global_set = new Set(["--global", "-g"]);
assert(global_home);

const command = process.argv[2];
const install = command === "install" || command === "i";
const is_global = process.argv.some((arg) => global_set.has(arg));
const global_install = install && is_global;

const cwd = global_install ? global_home : process.cwd();

const args = (() => {
  if (global_install) {
    return process.argv.filter((arg) => !global_set.has(arg));
  } else {
    return process.argv;
  }
})().filter((_, i) => i > 1);

if (global_install) {
  if (!existsSync(global_home)) {
    mkdirSync(global_home, { recursive: true });
  }
  const packages = join(global_home, "package.json");
  if (!existsSync(packages)) {
    spawnSync("npm", ["init", "-y"], {
      cwd,
      stdio: ["pipe", "inherit", "inherit"],
    });
  }
  console.log("-".repeat(process.stdout.columns));
  console.log(`@ - ${packages} - @`);
  console.log("-".repeat(process.stdout.columns));
}

const { status } = spawnSync("npm", [...args], {
  cwd,
  stdio: ["inherit", "inherit", "inherit"],
});
process.exit(status);

